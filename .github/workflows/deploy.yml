name: ğŸš€ Deploy Blog - VitePress

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  CI: true

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages-deploy-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # æ£€æŸ¥ä»£ç è´¨é‡
  lint:
    name: ğŸ” ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npx tsc --noEmit --skipLibCheck --skipLibCheck

      - name: ESLint æ£€æŸ¥
        run: npx eslint docs --ext .ts,.vue --quiet
        continue-on-error: true

  # æ„å»ºå’Œæµ‹è¯•
  build:
    name: ğŸ—ï¸ æ„å»ºåšå®¢
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run docs:build

      - name: æ„å»ºç»“æœæ£€æŸ¥
        run: |
          echo "ğŸ“ æ„å»ºç›®å½•ç»“æ„:"
          ls -la docs/.vitepress/dist/
          echo "ğŸ“Š æ„å»ºæ–‡ä»¶ç»Ÿè®¡:"
          find docs/.vitepress/dist -type f | wc -l

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… åšå®¢éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"

  # æ¸…ç†å·¥ä½œ
  cleanup:
    name: ğŸ§¹ æ¸…ç†å·¥ä½œ
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: æ¸…ç†ç¼“å­˜
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œå®Œæˆ"
          echo "ğŸ‰ åšå®¢éƒ¨ç½²æµç¨‹ç»“æŸ"

  # é€šçŸ¥ (å¯é€‰)
  notify:
    name: ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: éƒ¨ç½²çŠ¶æ€æ±‡æ€»
        run: |
          echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€æ±‡æ€»:"
          echo "- æ„å»º: ${{ needs.build.result }}"
          echo "- éƒ¨ç½²: ${{ needs.deploy.result }}"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date)"
